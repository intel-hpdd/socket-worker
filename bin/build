#!/usr/bin/env node

'use strict';

var join = require('path').join;
var browserify = require('browserify');
var fs = require('fs');
var mkdirp = require('mkdirp');
var path = require('path');

var srcMapName = 'bundle.map.json';
var moduleDir = path.dirname(__dirname);
var distDir = join.bind(null, moduleDir, 'dist');
var minifyifyDest = distDir(srcMapName);
var socketWorkerIndex = join(moduleDir, 'index.js');

mkdirp.sync(distDir());

browserify(socketWorkerIndex, { debug: true })
  .transform('babelify', {
    sourceMapRelative: moduleDir
  })
  .plugin('minifyify', { map: srcMapName, output: minifyifyDest })
  .bundle(function handleErrors (err) {
    if (err) throw err;
  })
  .pipe(fs.createWriteStream(distDir('bundle.js')));
